<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Retro Shooter - Ranked</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { 
            margin: 0; overflow: hidden; background-color: #050505; 
            font-family: 'Press Start 2P', cursive;
            cursor: crosshair; user-select: none;
        }

        /* --- LAYERS --- */
        #crt-layer {
            display: none; /* Default OFF */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 4px, 6px 100%; z-index: 10;
        }

        #ui-layer {
            display: none; position: absolute; top: 20px; left: 20px; color: #0f0; 
            text-shadow: 2px 2px 0 #000; z-index: 20;
            background: rgba(0, 0, 0, 0.6); padding: 20px; border: 2px solid #0f0;
            min-width: 320px;
        }

        /* --- PROGRESS BAR --- */
        #score-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
        #progress-container {
            width: 100%; height: 20px; border: 2px solid #0f0; background: #000; margin-bottom: 20px;
        }
        #progress-fill {
            width: 0%; height: 100%; background-color: #0f0; box-shadow: 0 0 10px #0f0;
            transition: width 0.1s linear;
        }

        /* --- SETTINGS --- */
        .setting-row { margin-top: 15px; font-size: 10px; color: #fff; display: flex; align-items: center; }
        .setting-row label { flex: 1; }
        input[type=range] { accent-color: #0f0; width: 100px; cursor: pointer; }
        input[type=radio] { accent-color: #0f0; cursor: pointer; margin-right: 5px; }

        #crosshair {
            display: none; position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: #f00; border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 20;
            box-shadow: 0 0 6px #f00; pointer-events: none;
        }

        /* --- OVERLAYS --- */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 60;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #0f0;
        }

        /* Specific Screen States */
        #loading-screen { z-index: 80; }
        #title-screen { display: none; z-index: 70; }
        #win-screen { display: none; z-index: 90; }

        h1.retro-title {
            font-size: 40px; color: #0f0;
            text-shadow: 4px 4px 0 #000, 0 0 20px #0f0;
            margin-bottom: 20px; text-align: center; line-height: 1.5;
        }

        .stat-box {
            border: 2px solid #fff; padding: 20px; margin-bottom: 20px;
            text-align: left; width: 300px; background: #111;
        }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; color: #fff; }
        .rank-text { font-size: 60px; color: yellow; text-align: center; margin: 10px 0; text-shadow: 0 0 20px orange; }

        button {
            background: #000; color: #0f0; border: 4px solid #0f0; 
            padding: 20px 40px; font-family: inherit; font-size: 18px;
            cursor: pointer; margin-top: 20px; box-shadow: 4px 4px 0 #000;
        }
        button:hover { background: #0f0; color: #000; transform: scale(1.05); }
        button:disabled { border-color: #555; color: #555; cursor: wait; }

    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="crt-layer"></div>
    <div id="crosshair"></div>

    <div id="ui-layer">
        <div id="score-header">
            <span id="hit-count">HITS: 0</span>
            <span id="percent-count">0%</span>
        </div>
        <div id="progress-container">
            <div id="progress-fill"></div>
        </div>
        
        <div class="setting-row">
            <label>MOUSE SENS:</label>
            <input type="range" id="sens-slider" min="1" max="10" value="3">
        </div>
        <div class="setting-row">
            <label>TV FILTER:</label>
            <div style="display:flex; align-items:center;">
                <input type="radio" name="tv" value="on"> ON
                <input type="radio" name="tv" value="off" style="margin-left: 10px;" checked> OFF
            </div>
        </div>
        <div style="font-size: 8px; color: #aaa; margin-top: 20px;">
            [WASD] MOVE &nbsp; [SHIFT] RUN &nbsp; [CLICK] FIRE
        </div>
    </div>

    <div id="loading-screen" class="overlay-screen">
        <div style="font-size: 20px; margin-bottom: 20px;">SYSTEM BOOT...</div>
        <div style="font-size: 10px; color: #888;">DOWNLOADING ASSETS</div>
    </div>

    <div id="title-screen" class="overlay-screen">
        <h1 class="retro-title">RETRO<br>SHOOTER</h1>
        <p style="font-size: 12px; margin-bottom: 40px; color:#fff;">ASSETS LOADED. SYSTEM READY.</p>
        <button id="start-btn">START MISSION</button>
    </div>

    <div id="win-screen" class="overlay-screen">
        <h1 class="retro-title">MISSION<br>COMPLETE</h1>
        
        <div class="stat-box">
            <div class="stat-line"><span>TARGETS:</span> <span id="end-targets">0</span></div>
            <div class="stat-line"><span>TIME:</span> <span id="end-time">0.00s</span></div>
            <div class="stat-line"><span>AVG SPEED:</span> <span id="end-rate">0.00s/kill</span></div>
            <hr style="border: 1px solid #555; margin: 15px 0;">
            <div style="text-align: center; font-size: 14px; color: #aaa;">RANKING</div>
            <div class="rank-text" id="end-rank">?</div>
        </div>

        <button onclick="location.reload()">NEXT MISSION</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- VARS ---
        let scene, camera, renderer, clock;
        let model, mixer;
        let actions = {};
        let activeActionName = 'Idle';
        
        let gameState = 'LOADING'; // LOADING -> TITLE -> PLAYING -> WON
        let hits = 0;
        let TOTAL_TARGETS = 0; 

        // Stats
        let startTime = 0;
        let endTime = 0;

        let mouseSensitivity = 0.003;
        let isLocked = false;
        const keys = { w: false, a: false, s: false, d: false, shift: false };
        
        let camAzimuth = Math.PI; 
        let camElevation = 0.2;   
        let camRadius = 3.5;      

        init();
        animate();

        function init() {
            // Random targets 10 to 34
            TOTAL_TARGETS = Math.floor(Math.random() * 25) + 10;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 10, 80);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Listeners
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('sens-slider').addEventListener('input', (e) => { mouseSensitivity = e.target.value / 1000; });
            document.querySelectorAll('input[name="tv"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.getElementById('crt-layer').style.display = (e.target.value === 'on') ? 'block' : 'none';
                });
            });

            // Lighting
            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
            scene.add(hemi);
            const dir = new THREE.DirectionalLight(0xffffff, 2.0);
            dir.position.set(20, 50, 20);
            dir.castShadow = true;
            scene.add(dir);

            clock = new THREE.Clock();

            // START LOADING IMMEDIATELY
            createEnvironment();
            loadCharacter(); // This triggers the Title Screen when done
            setupInputs();
        }

        function loadCharacter() {
            const loader = new GLTFLoader();
            loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {
                model = gltf.scene;
                model.traverse(o => { if(o.isMesh) o.castShadow = true; });
                
                // Rotation Fix
                model.rotation.y = Math.PI; 

                scene.add(model);

                mixer = new THREE.AnimationMixer(model);
                const clips = gltf.animations;
                
                // Safe Load
                const getClip = (name) => THREE.AnimationClip.findByName(clips, name) || clips[0];
                
                actions['Idle'] = mixer.clipAction(getClip('Idle'));
                actions['Run'] = mixer.clipAction(getClip('Run'));
                actions['Walk'] = mixer.clipAction(getClip('Walk'));
                
                actions['Idle'].play();

                // ASSETS LOADED -> SHOW TITLE SCREEN
                gameState = 'TITLE';
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('title-screen').style.display = 'flex';

            }, undefined, (error) => {
                console.error(error);
                document.getElementById('loading-screen').innerText = "ERROR LOADING MODEL.\nCHECK CONSOLE.";
            });
        }

        function startGame() {
            gameState = 'PLAYING';
            startTime = performance.now();
            
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            
            // Request lock immediately on start
            document.body.requestPointerLock();
        }

        function updateScoreDisplay() {
            const percent = Math.floor((hits / TOTAL_TARGETS) * 100);
            document.getElementById('hit-count').innerText = `HITS: ${hits}`;
            document.getElementById('percent-count').innerText = `${percent}%`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        function endGame() {
            gameState = 'WON';
            const durationMs = performance.now() - startTime;
            const durationSec = (durationMs / 1000).toFixed(2);
            
            // Calculate Rating
            // Seconds per Target
            const secondsPerTarget = durationMs / 1000 / hits;
            
            let rank = "F";
            if (secondsPerTarget < 0.8) rank = "S+";
            else if (secondsPerTarget < 1.0) rank = "S";
            else if (secondsPerTarget < 1.5) rank = "A";
            else if (secondsPerTarget < 2.0) rank = "B";
            else if (secondsPerTarget < 3.0) rank = "C";
            else rank = "D";

            // Fill Data
            document.getElementById('end-targets').innerText = TOTAL_TARGETS;
            document.getElementById('end-time').innerText = durationSec + "s";
            document.getElementById('end-rate').innerText = secondsPerTarget.toFixed(2) + "s/kill";
            
            const rankEl = document.getElementById('end-rank');
            rankEl.innerText = rank;
            
            // Color Coding Rank
            if(rank.includes("S")) rankEl.style.color = "gold";
            else if(rank === "A") rankEl.style.color = "#0f0";
            else if(rank === "B") rankEl.style.color = "#00f";
            else rankEl.style.color = "#888";

            document.exitPointerLock();
            document.getElementById('win-screen').style.display = 'flex';
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
        }

        function createEnvironment() {
            const texLoader = new THREE.TextureLoader();
            const grass = texLoader.load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
            grass.wrapS = grass.wrapT = THREE.RepeatWrapping;
            grass.repeat.set(50, 50);
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(250, 250), new THREE.MeshPhongMaterial({ map: grass }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Mats
            const cvs = document.createElement('canvas'); cvs.width = 64; cvs.height = 64;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = 'white'; ctx.fillRect(0,0,64,64);
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(32,32,20,0,Math.PI*2); ctx.fill();
            const targetMat = new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(cvs) });
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const buildMat = new THREE.MeshStandardMaterial({ color: 0x555555 });
            const treeMat = new THREE.MeshStandardMaterial({ color: 0x2e7d32 });
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x3e2723 });

            let targetsSpawned = 0;

            for(let i=0; i<150; i++) {
                const x = (Math.random()-0.5)*180;
                const z = (Math.random()-0.5)*180;
                if(Math.abs(x)<5 && Math.abs(z)<5) continue;

                const roll = Math.random();

                if(targetsSpawned < TOTAL_TARGETS && roll < 0.3) {
                    const t = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.2, 32), targetMat);
                    t.position.set(x, 1.5 + Math.random()*2, z); 
                    t.rotation.x = Math.PI/2; t.rotation.z = Math.random();
                    t.userData = { isTarget: true, hit: false };
                    scene.add(t); targetsSpawned++;
                } else if (roll < 0.5) {
                    const b = new THREE.Mesh(new THREE.BoxGeometry(1.5,1.5,1.5), boxMat);
                    b.position.set(x, 0.75, z); b.castShadow = true; scene.add(b);
                } else if (roll < 0.8) {
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.4,1.5), trunkMat);
                    trunk.position.set(x, 0.75, z); trunk.castShadow = true;
                    const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 3 + Math.random(), 8), treeMat);
                    leaves.position.set(x, 2.5, z); leaves.castShadow = true;
                    scene.add(trunk, leaves);
                } else {
                    const height = 2 + Math.random() * 3;
                    const build = new THREE.Mesh(new THREE.BoxGeometry(3, height*2, 3), buildMat);
                    build.position.set(x, height, z); build.castShadow = true; scene.add(build);
                }
            }
            while(targetsSpawned < TOTAL_TARGETS) {
                 const t = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.2, 32), targetMat);
                 t.position.set((Math.random()-0.5)*150, 1.5, (Math.random()-0.5)*150);
                 t.rotation.x = Math.PI/2; t.userData = { isTarget: true, hit: false };
                 scene.add(t); targetsSpawned++;
            }
            // Update initial UI
            updateScoreDisplay();
        }

        function setupInputs() {
            const handleKey = (e, val) => {
                if(e.code === 'KeyW') keys.w = val;
                if(e.code === 'KeyS') keys.s = val;
                if(e.code === 'KeyA') keys.a = val;
                if(e.code === 'KeyD') keys.d = val;
                if(e.code === 'ShiftLeft') keys.shift = val;
            };

            document.addEventListener('keydown', (e) => handleKey(e, true));
            document.addEventListener('keyup', (e) => handleKey(e, false));

            document.addEventListener('mousedown', (e) => {
                if(gameState !== 'PLAYING') return;
                if(e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
                
                if(!isLocked) {
                    document.body.requestPointerLock();
                } else {
                    if(e.button === 0) shoot();
                }
            });

            document.addEventListener('pointerlockchange', () => { isLocked = document.pointerLockElement === document.body; });

            document.addEventListener('mousemove', (e) => {
                if(!isLocked || gameState !== 'PLAYING') return;
                camAzimuth -= e.movementX * mouseSensitivity;
                camElevation -= e.movementY * mouseSensitivity;
                camElevation = Math.max(-0.5, Math.min(1.0, camElevation));
            });
        }

        function shoot() {
            camElevation += 0.01; 

            const flash = new THREE.PointLight(0xffff00, 2, 5);
            flash.position.copy(model.position).add(new THREE.Vector3(0,1.5,0));
            scene.add(flash);
            setTimeout(()=>scene.remove(flash), 50);

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            
            const lineGeo = new THREE.BufferGeometry().setFromPoints([
                model.position.clone().add(new THREE.Vector3(0,1.5,0)),
                raycaster.ray.at(50, new THREE.Vector3())
            ]);
            const line = new THREE.Line(lineGeo, new THREE.LineBasicMaterial({color: 0xff0000}));
            scene.add(line);
            setTimeout(()=>scene.remove(line), 50);

            const hitList = raycaster.intersectObjects(scene.children, true);
            if(hitList.length > 0) {
                let obj = hitList[0].object;
                while(obj.parent && !obj.userData.isTarget) { obj = obj.parent; }

                if(obj.userData.isTarget && !obj.userData.hit) {
                    obj.userData.hit = true;
                    
                    let s = 1;
                    const shrink = setInterval(() => {
                        s -= 0.1; obj.scale.set(s,s,s);
                        if(s <= 0) { clearInterval(shrink); scene.remove(obj); }
                    }, 20);

                    hits++;
                    updateScoreDisplay();

                    if(hits >= TOTAL_TARGETS) {
                        endGame();
                    }
                }
            }
        }

        function switchAction(name) {
            if (activeActionName === name) return;
            const prev = actions[activeActionName];
            const next = actions[name];
            if(prev && next) {
                prev.fadeOut(0.2);
                next.reset().fadeIn(0.2).play();
                activeActionName = name;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (model && mixer && gameState !== 'LOADING') {
                if(gameState === 'PLAYING') {
                    // Movement
                    const camDir = new THREE.Vector3();
                    camera.getWorldDirection(camDir);
                    camDir.y = 0; camDir.normalize();
                    const camRight = new THREE.Vector3();
                    camRight.crossVectors(camDir, new THREE.Vector3(0, 1, 0));
                    const moveVec = new THREE.Vector3();

                    if (keys.w) moveVec.add(camDir);
                    if (keys.s) moveVec.sub(camDir);
                    if (keys.d) moveVec.add(camRight);
                    if (keys.a) moveVec.sub(camRight);

                    if (moveVec.length() > 0) {
                        moveVec.normalize();
                        const speed = keys.shift ? 12 : 5;
                        model.position.addScaledVector(moveVec, speed * delta);

                        const moveAngle = Math.atan2(moveVec.x, moveVec.z);
                        const finalRotation = moveAngle + Math.PI; 
                        const targetQuat = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), finalRotation);
                        model.quaternion.slerp(targetQuat, 15 * delta);

                        switchAction(keys.shift ? 'Run' : 'Walk');
                    } else {
                        switchAction('Idle');
                    }
                }

                // Camera
                const head = model.position.clone().add(new THREE.Vector3(0, 1.7, 0));
                const cx = camRadius * Math.sin(camAzimuth) * Math.cos(camElevation);
                const cy = camRadius * Math.sin(camElevation);
                const cz = camRadius * Math.cos(camAzimuth) * Math.cos(camElevation);
                const offsetRight = new THREE.Vector3(Math.cos(camAzimuth), 0, -Math.sin(camAzimuth));
                const lookTarget = head.clone().add(offsetRight.multiplyScalar(0.8));

                camera.position.set(lookTarget.x + cx, lookTarget.y + cy, lookTarget.z + cz);
                camera.lookAt(lookTarget);

                mixer.update(delta);
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>